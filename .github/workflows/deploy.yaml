name: Deploy Python Worker to Azure

on:
  push:
    tags:
      - 'v*' # Trigger on version tags like v1.0.0 (Cite: 125)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # Cite: 181

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # Must match Azure Runtime (Cite: 124)

      - name: Install uv and Dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv pip install --system -r requirements.txt # Cite: 122, 182

      - name: Run Golden Dataset Test
        run: |
          pytest tests/test_model.py # Must pass > 80% to continue (Cite: 156, 157)

      - name: Package Application
        run: zip -r release.zip . -x "*.git*" "*tests*" "*.venv*" # Cite: 183

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2 # Cite: 184
        with:
          app-name: 'webappemail34'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: release.zip # Zip Deploy method (Cite: 179)